<!DOCTYPE html>
<html>
<head>
    <title>{{ titulo if titulo else 'Sistema de Gestão' }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Sistema de Gestão</a>
            {% if session.get('token') %}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/categorias">Categorias</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/produtos">Produtos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/fornecedores">Fornecedores</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Sair</a>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </nav>
    <div class="container">
        {% if pagina == 'login' %}
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <form method="POST" action="/">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Usuário:</label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha:</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Entrar</button>
                            </form>
                            {% if error %}
                            <div class="alert alert-danger mt-3">{{ error }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% elif pagina == 'crud' %}
            <h2 class="mb-4">{{ titulo }}</h2>

        <!-- Modal de Formulário -->
        <div class="modal fade" id="formModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Novo {{ titulo }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="entityForm">
                            <input type="hidden" id="id">
                            
                            {% for campo in campos %}
                            <div class="mb-3">
                                <label for="{{ campo.id }}" class="form-label">{{ campo.label }}:</label>
                                {% if campo.type == 'select' %}
                                    <select class="form-control" id="{{ campo.id }}" name="{{ campo.id }}" {% if campo.required %}required{% endif %}>
                                        <option value="">Selecione</option>
                                        {% for option in campo.options %}
                                        <option value="{{ option.id }}">{{ option.nome }}</option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <input type="{{ campo.type }}" class="form-control" id="{{ campo.id }}" name="{{ campo.id }}" {% if campo.required %}required{% endif %}>
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            <!-- Aqui, o container dos fornecedores será inserido no final do formulário -->
                            {% if titulo == 'Produtos' %}
                            <div class="mb-3">
                                <label for="fornecedores" class="form-label">Fornecedores:</label>
                            </div>
                            <div id="fornecedores-container">
                                <!-- Os checkboxes dos fornecedores serão inseridos aqui -->
                            </div>
                            {% endif %}

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarEntidade()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

            <!-- Tabela de Dados -->
            <div class="card">
                <div class="card-body">
                    <button class="btn btn-primary mb-3" onclick="novaEntidade()">Novo {{ titulo }}</button>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    {% for campo in campos %}
                                    <th>{{ campo.label }}</th>
                                    {% endfor %}
                                    {% if titulo == 'Produtos' %}
                                        <th>Fornecedores</th>
                                    {% endif %}
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            
            <div class="modal fade" id="viewModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Detalhes do {{ titulo }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <dl class="row" id="viewDetails">
                            </dl>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
            const API_URL = '/api/{{ endpoint }}';
            let editando = null;

            // Esse código só será executado após o carregamento completo do DOM
            document.addEventListener('DOMContentLoaded', () => {
                // Chama a função carregarFornecedores quando o modal for mostrado
                document.getElementById('formModal').addEventListener('show.bs.modal', carregarFornecedores);
            });

            async function carregarDados() {
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();

                    const fornecedoresResponse = await fetch('/api/fornecedores');
                    const fornecedoresData = await fornecedoresResponse.json();
                    const fornecedoresMap = Object.fromEntries(fornecedoresData.map(f => [f.id, f.nome]));

                    const tbody = document.getElementById('tableBody');
                    tbody.innerHTML = data.map(item => `
                        <tr>
                            {% for campo in campos %}
                            <td>${item.{{ campo.id }}}</td>
                            {% endfor %}
                            {% if titulo == 'Produtos' %}
                                <td>${Array.isArray(item.fornecedores) 
                                ? item.fornecedores.map(fId => fornecedoresMap[fId] || 'Desconhecido').join(', ') 
                                : 'Nenhum fornecedor'}
                                </td>
                            {% endif %}
                            <td>
                                <button class="btn btn-sm btn-info" onclick="visualizarEntidade(${item.id})">Ver</button>
                                <button class="btn btn-sm btn-warning" onclick="editarEntidade(${item.id})">Editar</button>
                                <button class="btn btn-sm btn-danger" onclick="excluirEntidade(${item.id})">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    alert('Erro ao carregar dados. Por favor, tente novamente.');
                }
            }

            async function carregarFornecedores() {
                try {
                    const response = await fetch('/api/fornecedores');
                    if (!response.ok) {
                        throw new Error('Erro ao carregar fornecedores');
                    }

                    const fornecedores = await response.json();
                    console.log('Fornecedores carregados:', fornecedores); // Verifique os dados

                    const container = document.getElementById('fornecedores-container');
                    
                    // Verifique se o contêiner existe antes de manipular
                    if (!container) {
                        console.error('Elemento #fornecedores-container não encontrado');
                        return;
                    }

                    container.innerHTML = ''; // Limpa qualquer conteúdo anterior

                    fornecedores.forEach(fornecedor => {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.classList.add('form-check');
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.classList.add('form-check-input');
                        checkbox.id = `fornecedor-${fornecedor.id}`;
                        checkbox.name = 'fornecedores[]'; // Usando o mesmo nome para garantir o envio em formato de lista
                        checkbox.value = fornecedor.id;

                        const label = document.createElement('label');
                        label.classList.add('form-check-label');
                        label.setAttribute('for', `fornecedor-${fornecedor.id}`);
                        label.textContent = fornecedor.nome;

                        checkboxDiv.appendChild(checkbox);
                        checkboxDiv.appendChild(label);
                        container.appendChild(checkboxDiv);
                    });
                } catch (error) {
                    console.error('Erro ao carregar fornecedores:', error);
                }
            }

            // Carrega fornecedores ao abrir o modal de produto
            document.getElementById('formModal').addEventListener('show.bs.modal', carregarFornecedores);

            async function visualizarEntidade(id) {
                try {
                    const response = await fetch(`${API_URL}/${id}`);
                    const data = await response.json();
                    
                    // If this is the products page, fetch category name
                    if ('{{ endpoint }}' === 'produtos') {
                        const catResponse = await fetch(`/api/categorias/${data.categoria_id}`);
                        const catData = await catResponse.json();
                        data.categoria_nome = catData.nome;
                    }

                    const viewDetails = document.getElementById('viewDetails');
                    viewDetails.innerHTML = `
                        {% for campo in campos %}
                        <dt class="col-sm-3">{{ campo.label }}</dt>
                        <dd class="col-sm-9">${
                            {% if endpoint == 'produtos' and campo.id == 'categoria_id' %}
                                data.categoria_nome || data.{{ campo.id }}
                            {% else %}
                                data.{{ campo.id }}
                            {% endif %}
                        }</dd>
                        {% endfor %}
                    `;
                    
                    new bootstrap.Modal(document.getElementById('viewModal')).show();
                } catch (error) {
                    console.error('Erro ao visualizar:', error);
                    alert('Erro ao carregar dados para visualização. Por favor, tente novamente.');
                }
            }
            async function novaEntidade() {
                editando = null;
                document.getElementById('entityForm').reset();
                document.getElementById('modalTitle').textContent = 'Novo {{ titulo }}';

                try {
                    const fornecedoresResponse = await fetch('/api/fornecedores');
                    const fornecedoresData = await fornecedoresResponse.json();
                    const fornecedoresSelect = document.getElementById('fornecedores');
                    fornecedoresSelect.innerHTML = fornecedoresData.map(f => `
                        <option value="${f.id}">${f.nome}</option>
                    `).join('');
                } catch (error) {
                    console.error('Erro ao carregar fornecedores:', error);
                }

                new bootstrap.Modal(document.getElementById('formModal')).show();
            }

            async function editarEntidade(id) {
                try {
                    const response = await fetch(`${API_URL}/${id}`);
                    const data = await response.json();
                    editando = id;
                    {% for campo in campos %}
                    document.getElementById('{{ campo.id }}').value = data.{{ campo.id }};
                    {% endfor %}
                    document.getElementById('modalTitle').textContent = 'Editar {{ titulo }}';
                    new bootstrap.Modal(document.getElementById('formModal')).show();
                } catch (error) {
                    console.error('Erro ao editar:', error);
                    alert('Erro ao carregar dados para edição. Por favor, tente novamente.');
                }
            }

            async function salvarEntidade() {
                try {
                    const form = document.getElementById('entityForm');
                    const formData = new FormData(form);

                    // Converta o FormData para um objeto e extraia os fornecedores
                    const data = Object.fromEntries(formData.entries());

                    // Captura os fornecedores selecionados
                    const fornecedores = formData.getAll('fornecedores[]');
                    if (fornecedores.length) {
                        data.fornecedores = fornecedores.map(Number); // Converte os IDs para números
                    }

                    // Se o campo de fornecedores não estiver presente, não o envie
                    if (!data.fornecedores) {
                        data.fornecedores = [];
                    }

                    // Determina o método de requisição (POST ou PUT, se estiver editando)
                    const method = editando ? 'PUT' : 'POST';
                    const url = editando ? `${API_URL}/${editando}` : API_URL;

                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });

                    if (!response.ok) {
                        const errorMsg = await response.text();
                        throw new Error(`Erro ao salvar: ${errorMsg}`);
                    }

                    // Fechar o modal e recarregar os dados
                    bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
                    carregarDados();
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    alert(`Erro ao salvar dados: ${error.message}. Por favor, tente novamente.`);
                }
            }
            async function excluirEntidade(id) {
                if (confirm('Tem certeza que deseja excluir?')) {
                    try {
                        const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                        if (!response.ok) {
                            throw new Error('Erro ao excluir');
                        }
                        carregarDados();
                    } catch (error) {
                        console.error('Erro ao excluir:', error);
                        alert('Erro ao excluir. Por favor, tente novamente.');
                    }
                }
            }

            carregarDados();
            </script>
        {% else %}
            <h2>Bem-vindo ao Sistema de Gestão</h2>
            <p>Escolha uma opção no menu acima para começar.</p>
        {% endif %}
    </div>
</body>
</html>